# 护照数据生成项目 - 错误记录与解决方案

## 🚨 关键错误记录

### 1. **护照号码长度错误** ❌
**错误**: 最初使用了10位护照号`E5WX436483`
**正确**: 应该使用9位护照号`E5WX43648`
**影响**: 导致BAC密钥生成错误，认证失败
**解决**: 修正`passport_info`中的`passport_number`为9位

### 2. **SOD文件格式问题** ❌
**错误**: 
- 最初生成简化版SOD（273字节）
- 后来直接修改原始文件字节破坏TLV结构
**正确**: 使用标准PKCS#7 SignedData结构（1580字节）
**影响**: JMRTD解析时出现`NullPointerException`
**解决**: 完全重构SOD生成逻辑，从头构建PKCS#7结构

### 3. **MRZ生成逻辑错误** ❌
**错误**: 
- MRZ第一行长度错误（45位而非44位）
- MRZ字段顺序和校验位计算错误
- TLV编码问题导致数据错位
**正确**: 
- 第一行: `P<ARESAMARA<<NOUR<<<<<<<<<<<<<<<<<<<<<<<<<<<<` (44位)
- 第二行: `E5WX436483ARE9108253M3206294<<<<<<<<<<<<<<00` (44位)
**影响**: 导致JMRTD无法正确读取MRZ数据
**解决**: 重写MRZ生成逻辑，使用正确的校验位计算

### 4. **COM文件格式错误** ❌
**错误**: 
- LDS版本使用1.8而非1.7
- DG列表使用DG编号而非TLV标签值
- 外层标签使用0x6E而非0x60
**正确**: 
- LDS版本: `0107` (1.7版本)
- DG列表: `616b6c6f75` (TLV标签值)
- 外层标签: `0x60`
**影响**: 文件格式不符合预期
**解决**: 分析原始文件结构并修正

## 📋 正确的护照信息

```python
passport_info = {
    'document_type': 'P',
    'issuing_country': 'ARE',
    'last_name': 'SAMARA',
    'first_name': 'NOUR',
    'passport_number': 'E5WX43648',    # ✅ 9位
    'nationality': 'ARE',
    'date_of_birth': '910825',         # ✅ YYMMDD
    'sex': 'M',
    'date_of_expiry': '320629',        # ✅ YYMMDD
    'personal_number': '',             # ✅ 空
}
```

## 🔧 关键技术要点

### MRZ格式
- **第一行**: 44位，格式：`P<ARE SAMARA<<NOUR<填充<`
- **第二行**: 44位，格式：`护照号+校验+国籍+生日+校验+性别+过期+校验+个人号+校验+最终校验`

### BAC密钥生成
- **使用字段**: 护照号(9位) + 出生日期(6位) + 过期日期(6位)
- **密钥种子**: `E5WX43648391082533206294` (总长24位)

### SOD结构
- **必须**: 完整的PKCS#7 SignedData结构
- **包含**: 证书链、签名信息、DG哈希值
- **大小**: 约1580字节（标准版）vs 273字节（简化版，不可用）

### 文件大小参考
| 文件 | 正确大小 | 说明 |
|------|----------|------|
| COM  | 25字节   | 通用数据元素 |
| DG1  | 93-94字节| MRZ数据 |
| DG2  | 16000+字节| 面部图像(JPEG) |
| DG11 | 44字节   | 附加个人信息 |
| DG12 | 34字节   | 附加文档信息 |
| DG15 | 298字节  | 主动认证公钥(2048位RSA) |
| SOD  | 1580字节 | 安全对象数据(完整PKCS#7) |

## ⚠️ 常见陷阱

1. **不要混淆护照号长度**: 9位基础号码 + 1位校验位 = 10位总长
2. **不要简化SOD**: 必须包含完整证书链，否则JMRTD解析失败
3. **注意TLV编码**: 长度字段使用0x81/0x82前缀处理大于127的值
4. **MRZ校验位**: 每个字段都有独立校验位，最后还有总校验位

## 🎯 调试建议

1. **始终验证文件大小**: 与原始文件对比，差异过大说明有问题
2. **分步测试**: 先生成COM、DG1等简单文件，确认无误后再处理SOD
3. **使用hex工具**: 对比生成文件与原始文件的十六进制差异
4. **JMRTD测试**: 使用桌面版JMRTD验证生成的数据是否可读

## 🚀 项目最终结构

### 主要文件
1. **generate_certificate.py** - 生成CSCA证书、公钥、私钥
2. **generate_sod.py** - 生成SOD文件（使用OpenSSL证书）
3. **generate_all_passport_data.py** - 生成所有DG文件  
4. **upload_data.py** - 上传数据到智能卡

### 改进记录 (2025-08-21)
- ✅ 分离证书生成和SOD生成为独立文件
- ✅ 使用OpenSSL标准算法生成ECC证书
- ✅ 完整的PKCS#7 SignedData结构
- ✅ 支持RSA和ECDSA两种签名算法
- ✅ 详细的配置注释和修改指南
- ✅ 自动验证证书和SOD文件有效性

### 使用流程
```bash
# 1. 生成证书和密钥
python generate_certificate.py

# 2. 生成所有DG文件
python generate_all_passport_data.py

# 3. 生成SOD文件
python generate_sod.py

# 4. 上传到智能卡
python upload_data.py
```